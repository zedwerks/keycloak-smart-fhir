{
  "info": {
    "_postman_id": "6b6a2a5f-9f9a-4c2f-b1ef-7a5e6f1f9a01",
    "name": "Keycloak PKCE Explicit Flow",
    "description": "Explicit OAuth 2.0 Authorization Code + PKCE flow (no OAuth tab). Works with Keycloak and SMART-on-FHIR.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    { "key": "keycloak_base", "value": "https://localhost:8443" },
    { "key": "realm", "value": "smart" },
    { "key": "client_id", "value": "smart-app" },
    { "key": "redirect_uri", "value": "http://localhost:8080/callback" },
    { "key": "scope", "value": "openid fhirUser patient/*.read" },
    { "key": "code_verifier", "value": "" },
    { "key": "code_challenge", "value": "" },
    { "key": "auth_code", "value": "" },
    { "key": "access_token", "value": "" },
    { "key": "id_token", "value": "" }
  ],
  "item": [
    {
      "name": "Authorize (PKCE)",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "function base64UrlEncode(buffer) {",
              "  return CryptoJS.enc.Base64.stringify(buffer)",
              "    .replace(/\\+/g, '-')",
              "    .replace(/\\//g, '_')",
              "    .replace(/=+$/, '');",
              "}",
              "",
              "function generateCodeVerifier() {",
              "  const random = CryptoJS.lib.WordArray.random(32);",
              "  return base64UrlEncode(random);",
              "}",
              "",
              "function generateCodeChallenge(verifier) {",
              "  const hash = CryptoJS.SHA256(verifier);",
              "  return base64UrlEncode(hash);",
              "}",
              "",
              "const verifier = generateCodeVerifier();",
              "const challenge = generateCodeChallenge(verifier);",
              "",
              "pm.environment.set('code_verifier', verifier);",
              "pm.environment.set('code_challenge', challenge);",
              "",
              "console.log('PKCE verifier:', verifier);",
              "console.log('PKCE challenge:', challenge);"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{keycloak_base}}/realms/{{realm}}/protocol/openid-connect/authorize?response_type=code&client_id={{client_id}}&redirect_uri={{redirect_uri}}&scope={{scope}}&code_challenge={{code_challenge}}&code_challenge_method=S256&state=test-state&nonce=test-nonce",
          "host": ["{{keycloak_base}}"],
          "path": [
            "realms",
            "{{realm}}",
            "protocol",
            "openid-connect",
            "authorize"
          ],
          "query": [
            { "key": "response_type", "value": "code" },
            { "key": "client_id", "value": "{{client_id}}" },
            { "key": "redirect_uri", "value": "{{redirect_uri}}" },
            { "key": "scope", "value": "{{scope}}" },
            { "key": "code_challenge", "value": "{{code_challenge}}" },
            { "key": "code_challenge_method", "value": "S256" },
            { "key": "state", "value": "test-state" },
            { "key": "nonce", "value": "test-nonce" }
          ]
        }
      },
      "response": []
    },
    {
      "name": "Token (PKCE Exchange)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "const body = pm.response.json();",
              "",
              "pm.environment.set('access_token', body.access_token);",
              "pm.environment.set('id_token', body.id_token);",
              "",
              "console.log('Access token stored');",
              "",
              "if (body.id_token) {",
              "  const payload = JSON.parse(atob(body.id_token.split('.')[1]));",
              "  console.log('ID token payload:', payload);",
              "",
              "  if (payload.patient) {",
              "    pm.environment.set('patient', payload.patient);",
              "  }",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/x-www-form-urlencoded"
          }
        ],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            { "key": "grant_type", "value": "authorization_code" },
            { "key": "client_id", "value": "{{client_id}}" },
            { "key": "code", "value": "{{auth_code}}" },
            { "key": "redirect_uri", "value": "{{redirect_uri}}" },
            { "key": "code_verifier", "value": "{{code_verifier}}" }
          ]
        },
        "url": {
          "raw": "{{keycloak_base}}/realms/{{realm}}/protocol/openid-connect/token",
          "host": ["{{keycloak_base}}"],
          "path": [
            "realms",
            "{{realm}}",
            "protocol",
            "openid-connect",
            "token"
          ]
        }
      },
      "response": []
    }
  ]
}